# 생성자에 매개변수가 많다면 빌더를 고려하라

정적 팩토리와 생성자는 선택적 매개변수가 많을 때 적절히 대응하기 어렵다는 단점을 가지고 있다.

## 해결 방식

### 1. 점층적 생성자 패턴

- 생성자 오버로딩을 사용하여 객체의 생성자를 여러 개 제공하는 패턴
- 매개변수가 많아지면 클라이언트 코드를 작성하거나 읽기 어려움
  - 코드를 읽을 때 각 값이 어느 값인지 헷갈리며 매개변수의 개수를 파악하기도 힘들 수 있음
  - 이는 버그가 있을 때 찾이 어려운 버그로 이어질 수 있으며 런타임 시점에 엉뚱한 동작으로 이어질 수 있음

### 2. 자바빈즈 패턴

- 매개변수가 없는 생성자로 객체를 만든 후 Setter 메소드를 이용하는 방법
- 객체 하나를 만들기 위해 메소드를 여러 개 호출해야함
- 객체가 완전히 생성되기 전까지는 일관성이 무너진 상태에 놓임
  - 생성자에서 매개변수들이 유효함을 확인할 수 있었는데 그럴 수 없게됨
  - 버그가 일어나는 곳과 버그 때문에 문제를 겪는 코드가 물리적으로 떨어져있게 됨
- 클래스를 불변으로 만들 수 없음
- freeze 메소드를 이용해 객체를 수동으로 얼리기도 하지만 사용이 어렵고 개발자의 호출을 확실히 보장해줄 수 없어서 런타임 오류에 취약함

### 3. **빌더 패턴**

- 필수 매개 변수만으로 생성자 혹은 정적 팩토리 메소드를 호출해 빌더 객체를 얻음
- 점층적 생성자 패턴의 안정성과 자바빈즈 패턴의 가독성 즉 두 패턴의 장점만을 가짐

## 빌더 패턴

- 클라이언트는 필수 매개변수만으로 생성자를 호출해 빌더 객체를 얻는다.
- 이후 빌더 객체가 제공하는 일종의 세터 메소드들로 원하는 선택 매개변수들을 설정한다.
- 마지막으로 매개변수가 없는 build 메소드를 호출해 객체를 얻는다.

### 빌더 패턴의 구현

- 빌더는 생성할 클래스 안에 정적 멤버 클래스로 만들어두는게 보통이다.
- 빌더의 세터 메서드들은 빌더 자신을 반환하기 때문에 연쇄적으로 호출할 수 있다.
  - 메소드 호출이 흐르듯 연결된다는 뜻으로 fluent API 혹은 method chaining이라고 함
  ```java
  NutritionFacts cocaCola = new NutritionFacts.Builder(240, 8) // 필수 요소
                  .calories(100)
                  .sodium(35)
                  .carbohydrate(27)
                  .build();
  ```
- 이는 파이썬과 스칼라의 명명된 매개변수를 흉내낸 것이라고 한다
  ```python
  def add_book(title, author, year=None, pages=None):
      book = {
          'title': title,
          'author': author,
          'year': year,
          'pages': pages
  }
  ```
- 유효성 검사의 경우 빌더의 생성자와 메소드에서 입력 매개변수를 검사하고 build 메소드가 호출하는 생성자에서 여러 매개변수에 걸친 불변식을 검사하면 된다.
  - 공격에 대비해 불변식을 보장하려면 빌더로부터 매개변수를 복사한 후 해당 객체 필드들도 검사해야함

### 빌더 패턴의 장점

- 가독성과 명확성
- 객체 생성의 안정성(객체가 불완전한 상태로 존재할 가능성을 줄임)
- 계층적으로 설계된 클래스(상속을 통해 여러 계층으로 구현된 클래스)와 함께 쓰기에 좋다.
  - 각 계층의 클래스에 관련 빌더를 멤버로 정의
  - 추상 클래스는 추상 빌더, 구체 클래스는 구체 빌더를 갖게
  - 추상 메소드 self(라위 클래스가 해당 메소드를 재정의해 this를 반환하도록 구현 필요)를 통해 하위 클래스에서 형변환하지 않고 메소드 연쇄를 지원할 수 있음
    - 이를 공변 반환 타이핑이라고 함 (원래 반환 타입의 하위 타입을 반환할 수 있도록 함)
- 가변인수 매개변수(동일한 타입의 인자를 하나 이상 또는 여러 개 전달할 수 있게 해 주는 매개변수)를 여러개 사용할 수 있음
- 빌더 하나로 여러 객체를 순회하며 만들 수 있음, 빌더에 넘기는 매개변수에 따라 다른 객체를 만들 수 있음

### 빌더 패턴의 단점

- 객체 생성을 위해 빌더를 만들어야한다.
  - 빌더 생성 비용이 크지는 않지만 성능에 민감한 상황에서는 문제가 될 수 있음
- 매개변수가 적은 상황에는 어울리지 않는다.
  - 최소 4개는 돼야 그 의미가 생긴다

### 마무리

- 생성자나 정적 팩터리 방식을 쓰다가 필요시 변경해도 좋으나 API의 경우 매개변수가 많아지는 것을 고려해 처음부터 빌더패턴을 쓰는 것도 괜찮다
- 매개변수가 많고 타입이 비슷할 경우에 클라이언트 코드의 가독성과 작성 편이성을 위해 빌더를 채택하는 것이 좋다.
